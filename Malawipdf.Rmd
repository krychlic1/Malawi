---
title: "Spatial Analysis of Crop Yields in Malawi"
author: "Kathleen Rychlicki"
date: "November 16, 2015"
output: pdf_document
---

---
```{r message=F,warning=FALSE}
# loading required packages

library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(raster)
library(rasterVis)
library(xtable)
library(scales)
library(FAOSTAT)
library(MODISTools)
library(gdalUtils)
library(rts)
library(countrycode)
library(sp)
library(rgeos)
library(rgdal)
library(ncdf)


```
```{r, echo = FALSE}
setwd("C://Users//katie//Documents//GEO 503//Week 10")
```
###**Abstract**
This report offers a spatial analysis on the crop yields for Malawi, a small region in Africa, over time in relation to the land cover of the cropland. The climate of the area over time is examined to see the effects of climate on the crop yields. The data has been aggregated and agricultural pixels pulled from MODIS for the region. The report looks at 500m croplands and analyzes assumptions below as to other factors, such as market, that would affect the crops.

###**Introduction**

Malawi is at a latitude and longitude, 13.9500° S, 33.7000° E, respectively. According to the FAOSTAT Data, the top 3 crop yields in Malawi are Cassava, Maize and Potatoes. However, after observing the data (shown in data and methods), the yields for all three crops were low during (insert years - FAOSTAT website is currently down). The following report will analyze the land cover/vegetation(NVDI) index to observe the land of Malawi that is responsible for producing crops. After this, the climate data for the country will be examined. Climate indices that will help inform of the reason for the low crops are annual mean temperature, annual precipitation and the number of frost days. 


###**Data and Methods**
_[Malawi Country Data}_

Data is obtained from the FAO*. Country level (1) data is obtained for Malawi .
```{r}

getData("ISO3")%>%
  as.data.frame%>%
  filter(NAME=="Malawi")


```

```{r}
#Plotting Malawi borders
mw=getData('GADM', country='MWI', level=1)
mw2=gSimplify(mw,tol = 0.1,topologyPreserve=T)
plot(mw2,lwd=2)
mw3=plot(mw2,border="purple",add=T)
```
<span style="color:blue">Still working on figuring out best way to plot the country level data, by pixels, area, mean, etc.</span>

####**Elevation Data**
```{r}

mwi=gCentroid(mw2)%>%coordinates()

dem1=getData("SRTM",lat=mwi[2],lon=mwi[1])
plot(dem1)
plot(mw2,add=T)

dem2=getData("SRTM",lat=-13.9500,lon=33.7000)
dem=merge(dem1,dem2)
plot(dem)
plot(mw2,add=T)
```

<span style="color:blue">Still deciding if elevation data is necessary to the analysis</span>

####**Crop Yields**

Crop Yield data is obtained from the FAOSTAT. 
Crop Yields will be examined using the top 3 crops yielded in Malawi: Cassava, Maize, Potatoes.


<span style="color:blue">So far: Have downloaded data frames for the 3 crops. However, have been unsuccessful thus far at plotting the data or producing a displayable table. It appears FAOSTAT does not support a multiple item code to their getFAO function. Also,working on plotting the crop yield and overlaying the area harvested to have a visual of what area is being harvested in relation to the crops.</span>

<span style="color:blue"> The following crop codes are able to run in R console, however, when being knit in R Markdown, still receiving error so do not currently have visual data:

**First Method Attempt**

df <- getFAO(name = "Crops", 
             domainCode = "QC", 
             elementCode = 5419, 
             itemCode = 116,
             countrySet = 130)

**Second Method Attempt**

Maize.df = getFAOtoSYB(name = c("Area Harvested", "Yield", "Production"), domainCode = c("QC", "QC", "QC"), elementCode = c(5312,5419,5510), itemCode =c(56, 56, 56), printURL = FALSE, useCHMT = TRUE, outputFormat = "wide",countrySet = 130)

Cassava.df = getFAOtoSYB(name = c("Area Harvested", "Yield", "Production"), domainCode = c("QC", "QC", "QC"), elementCode = c(5312,5419,5510), itemCode =c(125, 125, 125), printURL = FALSE, useCHMT = TRUE, outputFormat = "wide",countrySet = 130)
 
Potatoes.df = getFAOtoSYB(name = c("Area Harvested", "Yield", "Production"), domainCode = c("QC", "QC", "QC"), elementCode = c(5312,5419,5510), itemCode =c(116, 116, 116), printURL = FALSE, useCHMT = TRUE, outputFormat = "wide",countrySet = 130)


**FAO Codes:**

Crop          | Code
------------- | ------------- 
Cassava       | 125      
Maize         | 56
Potatoes      | 116

Element       | Code
------------- | ------------- 
Area Harvested| 5312     
Yield         | 5314
Production    | 5510


####**Climate Data**
Climate Data is obtained from WorldClim The average mean temperature and precipitation levels have been obtained.

<span style="color:blue">Working on figuring out which climate data will be best to present (e.g. Annual Average Temperature, Maximum Temperature, Minimum Temperature, Precipitation, Seasonal, Frost Dates,etc. -- Look at CDO Climate Indices</span>

**_[Annual Mean Temperature]_**


```{r}
#Annual mean temperature cropped and aggregated as a function of the mean
clim <-getData ('worldclim', var='bio', res=10)
r1 <- crop(clim[[1]], bbox(mw2))
r1 <- crop(clim[[1]], extent(32,37,-17,-8))
r1
aggregate(r1, 3, fun=mean) %>%
  plot(,
       main="Annual Mean Temperature")
```
```{r}
#Annual Precipatation cropped and aggregated as a function of the mean
r2 <- crop(clim[[12]], bbox(mw2))
r2 <- crop(clim[[12]], extent(32,37,-17,-8))
r2
aggregate(r2, 4, fun=mean) %>%
  plot(,
    main="Annual Precipitation")
```

<span style="color:blue">Add axis labels</span>

####**Land Cover**
Using MODIS data, Malawi is located at the horizontal 21 and vertical 10 position of the MODIS gridding system. The products MCD12Q1(Land Cover Type Yearly L3 Global 500m SIN Grid) and MOD13A1(Vegetation Indices 16-Day L3 Global 500m)

As taken from the NASA Earth Data, the Land Cover Type product will provide data characterizing five global land classification systems. The Vegetation Indices are designed to provide consistent spatial and temporal comparisons of vegetation conditions using the MODIS Normalized Difference Vegetation Index (NDVI) 

```{r}
datadir="data"
```
```{r, eval=FALSE}
#Testing for HDFfunctionality

gdalinfo(formats = T) %>% grep(pattern="HDF",value=T)
hdf=file.path(datadir,"MCD12Q1.A2004001.h21v10.051.2014287180042.hdf")

#Finding subdatasets: 

gdalinfo(hdf,nomd=T)
```
```{r}
#Plotting raster of MCD12Q1 for Malawi tiles

gdal_translate("HDF4_EOS:EOS_GRID:\"data/MCD12Q1.A2004001.h21v10.051.2014287180042.hdf\":MOD12Q1:Land_Cover_Type_1",
               "test.tif")
d=raster("test.tif")
plot(d)
plot(mw2, add = T)

```
```{r, eval=FALSE}
#Retrieving bands for MCD12Q1 and MOD13Q1
GetBands(Product = "MCD12Q1")
GetBands(Product = "MOD13A1")
```
```{r}
#Binding the data frame by latitude and longitude coordinates
loc=rbind.data.frame(
  list("Malawi",-13.9500, 33.7000))
colnames(loc)=c("loc","lat","long")
coordinates(loc)=cbind(loc$long,loc$lat)

#Changing date format

mdates=GetDates(Product = "MCD12Q1", Lat = loc$lat[1], Long = loc$long[1])
dates=mdates%>%sub(pattern="A",replacement="")%>%as.Date("%Y%j")

loc$start.date <- min(as.numeric(format(dates,"%Y")))
loc$end.date <- max(as.numeric(format(dates,"%Y")))
```
```{r}
lcdir=file.path(datadir,"lc")
if(!file.exists(lcdir)) dir.create(lcdir)
```
```{r, eval=FALSE}
#
MODISSubsets(LoadDat = loc,
             Products = c("MCD12Q1"),
             Bands = c( "Land_Cover_Type_1"),
             Size = c(10,10),
             SaveDir=lcdir,
             StartDate=T)

MODISGrid(Dir = lcdir, 
          DirName = "modgrid",
          SubDir = TRUE, 
          NoDataValues=
              list("MCD12Q1" = c("Land_Cover_Type_1" = 255)))
```
```{r}
lc_files=list.files(file.path(lcdir,"modgrid"),recursive=T,
                     pattern="Land_Cover_Type_1.*asc",full=T)
lc=raster(lc_files[1])
plot(lc)
```
<span style="color:blue">Working on overlaying the vegetation index, which may provide more useful than land cover. To be examined.</span>

<span style="color:blue">**For all data, ensure graphs, plots, and datasets are examined over same year period. Also add plot titles & Axis**</span>

####**Results**

Expected results: Expect to find that there is a climate change or reason for reduced crops during certain years. However, this could also be due to market fluctuation or more severe weather occurrences during that time. Also, resources to the farmers producing the crops may not have been available. Now with increased technology and resources, farmers may have found new technology or updated processes in order to increase their yields. Will have a better representation of this in final project when all data is able to be analyzed.

####**Discussion/Conclusion**



####**References**
(More references to come...)

FAO:

http://www.fao.org/
http://www.fao.org/nr/gaez/about-data-portal/agricultural-suitability-and-potential-yields/en/  
http://faostat.fao.org/site/375/default.aspx
http://faostat.fao.org/site/567/DesktopDefault.aspx?PageID=567#ancor


